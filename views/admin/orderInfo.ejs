<%- include('../adminLayouts/header.ejs') %>
<%- include('../adminLayouts/sidebar.ejs') %>
<%- include('../adminLayouts/navbar.ejs') %>

<style>
    .form-select.cancelled {
    color: red;
    background-color: white;
    }

</style>

<div class="main-panel">
    <div class="content-wrapper">
        <div class="container-fluid">
            <h2 class="mt-4">Order Details</h2>
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            Order Information
                        </div>
                        <div class="card-body">
                            <p><strong>Order ID:</strong> <%= order.orderTrackId %></p>
                            <p><strong>Order Date:</strong> <%= order.createdAt.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: '2-digit' }).replace(/\//g, '-') %></p>
                            <p><strong>Payment Method: </strong> <%= order.paymentMethod %></p>
                            <p><strong>Payment Status: </strong> <%= order.paymentStatus %></p>
                            <p><strong>Instructions: </strong> <%= order.notes %></p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            Address
                        </div>
                        <div class="card-body">
                            <p><strong>Full Name:</strong> <%= order.address.fullName %></p>
                            <p><strong>City:</strong> <%= order.address.city %></p>
                            <p><strong>District:</strong> <%= order.address.district %></p>
                            <p><strong>State:</strong> <%= order.address.state %></p>
                            <p><strong>Pincode:</strong> <%= order.address.pincode %></p>
                            <p><strong>Mobile:</strong> <%= order.address.mobile %></p>

                        </div>
                    </div>
                </div>
            </div>
            <div class="row mt-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            Products
                        </div>
                        <div class="card-body">
                            <% order.products.forEach(product => { %>
                                <div class="row mb-3">
                                    <div class="col-md-2">
                                        <img src="/static/admin/Assets/images/products/<%= product.productId.image[0] %>" alt="Product Image" style="width: 75px;">
                                    </div>
                                    <div class="col-md-4">
                                        <h5><%= product.productId.productname %></h5>
                                        <p class="mb-1">Quantity: <%= product.quantity %></p>
                                        <p class="mb-2">Price: <%= product.price %></p>
                                        <p>Subtotal: <%= product.subtotal %></p>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <p class="mb-0"><strong>Status:</strong></p>
                                                <select class="form-select productStatus <%= product.status === 'Cancelled' ? 'cancelled' : '' %>"
                                                    data-product-id="<%= product._id %>"
                                                    id="productStatus_<%= product._id %>"
                                                    onchange="updateProductStatus('<%= order._id %>', '<%= product._id %>', '<%= product.status %>')"
                                                    <%= product.status === 'Cancelled' ? 'disabled' : '' %>
                                                    <%= product.status === 'Return' ? 'disabled' : '' %>
                                                    >
                                                    <option value="Order Placed" <%= product.status === 'Order Placed' ? 'selected' : '' %>>Order Placed</option>
                                                    <option value="Shipped" <%= product.status === 'Shipped' ? 'selected' : '' %>>Shipped</option>
                                                    <option value="Out for Delivery" <%= product.status === 'Out for Delivery' ? 'selected' : '' %>>Out for Delivery</option>
                                                    <option value="Delivered" <%= product.status === 'Delivered' ? 'selected' : '' %>>Delivered</option>
                                                    <option value="Cancelled" <%= product.status === 'Cancelled' ? 'selected' : '' %>>Cancel</option>
                                                    <option value="Return" <%= product.status === 'Return' ? 'selected' : '' %> disabled>Return</option>
                                                </select>
                                                
                                            </div>
                                            <div class="col-md-6">
                                                <p>
                                                    <strong>Return Status:</strong>
                                                    <select class="form-select returnStatus" data-product-id="<%= product._id %>">
                                                        <option value="Select">Select Status</option>
                                                        <option value="Return Placed" <%= product.returnStatus === 'Return Placed' ? 'selected' : '' %>>Return Placed</option>
                                                        <option value="Out for Pickup" <%= product.returnStatus === 'Out for Pickup' ? 'selected' : '' %>>Out for Pickup</option>
                                                        <option value="Returned" <%= product.returnStatus === 'Returned' ? 'selected' : '' %>>Returned</option>
                                                    </select>
                                                </p>
                                                <button class="btn btn-md btn-warning refund-btn" style="color: black;" data-product-id="<%= product._id %>" disabled>Refund</button>

                                            </div>
                                        </div>                                      
                                     
                                   
                                    </div>
                                </div>
                            <% }); %>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>




<script>
    document.addEventListener('DOMContentLoaded', function () {
        const orderId = '<%= order._id %>';

        const productStatusSelects = document.querySelectorAll('.productStatus');
        productStatusSelects.forEach((select) => {
            select.addEventListener('change', handleProductStatusChange);
        });

        // Function to handle product status change
        async function handleProductStatusChange(event) {
            const productId = event.target.getAttribute('data-product-id');

            // Check if the selected status is "Return"
            if (event.target.value === 'Return') {
                // Disable the "Return" option
                event.target.value = ''; // Reset the selected value
                return;
            }

            // Fetch to update product status on the server
            const response = await fetch('/admin/updateProductStatus', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    orderId: orderId,
                    productId: productId,
                    productStatus: event.target.value,
                }),
            });

            if (!response.ok) {
                console.error('Failed to update product status on the server');
            } else {
                console.log('Product status updated successfully');
                // Optionally, you can handle success here
            }
        }
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const orderId = '<%= order._id %>';

        const returnStatusSelects = document.querySelectorAll('.returnStatus');
        returnStatusSelects.forEach((select) => {
            select.addEventListener('change', handleReturnStatusChange);
            // Initial check to enable/disable refund button based on initial return status
            handleReturnStatusChange({ target: select });
        });

        // Function to handle return status change
        async function handleReturnStatusChange(event) {
            const productId = event.target.getAttribute('data-product-id');
            const refundButton = document.querySelector(`.refund-btn[data-product-id="${productId}"]`);

            if (event.target.value === 'Returned') {
                refundButton.removeAttribute('disabled');
            } else {
                refundButton.setAttribute('disabled', true);
            }

            // Fetch to update return status on the server
            const response = await fetch('/admin/updateReturnStatus', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    orderId: orderId,
                    productId: productId,
                    returnStatus: event.target.value,
                }),
            });

            if (!response.ok) {
                console.error('Failed to update return status on the server');
            }
        }
    });
</script>
    

<%- include('../adminLayouts/footer.ejs') %>
