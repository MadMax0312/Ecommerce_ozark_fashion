<%- include('../adminLayouts/header.ejs') %> 
<%- include('../adminLayouts/sidebar.ejs') %> 
<%- include('../adminLayouts/navbar.ejs') %>




<div class="main-panel">
    <div class="content-wrapper">
        <div class="col-lg-12 grid-margin stretch-card">
            <div class="card">
                <div class="card-body">
                    <h2 class="card-title" style="text-align: center">PRODUCTS</h2>

                    <form class="search-form">
                        <input
                            type="text"
                            name="search"
                            placeholder="Product name or Size"
                            class="search-input"
                        />
                        <button type="submit" class="search-button">
                            Search <i class="mdi mdi-magnify"></i>
                        </button>
                    </form>

                    <br />

                    <div class="table-responsive">
                        <table class="table table-dark" id="product-table">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Category</th>
                                    <th>Size</th>
                                    <!-- <th> Color </th> -->
                                    <th>Price</th>
                                    <th>Quantity</th>
                                    <th>Image</th>
                                    <th>Edit</th>
                                    <th>Action</th>
                                </tr>
                            </thead>

                            <% if (Product.length > 0) { for (let i = 0; i < Product.length; i++) { %>
                            <tr>
                                <td><%= Product[i].productname %></td>
                                <td><%= Product[i].category.categoryname %></td>
                                <td><%= Product[i].size %></td>

                                <!-- <td><%= Product[i].color %></td> -->
                                <td><%= Product[i].price %></td>
                                <td><%= Product[i].quantity %></td>
                                <td>
                                    <% if (Product[i].image && Product[i].image.length > 0) { %> <% const visibleImages =
                                    Product[i].image.filter(image => !deletedImages.includes(image)).slice(0, 4); %> <%
                                    visibleImages.forEach(image => { %>
                                    <img
                                        src="/static/admin/Assets/images/products/<%= image %>"
                                        alt="<%= Product[i].productname %>"
                                    />
                                    <% }); %> <% } %>
                                </td>
                                <td>
                                    <a href="/admin/edit-product">
                                        <a
                                            href="/admin/edit-product?id=<%= Product[i]._id %>"
                                            class="btn btn-outline-secondary btn-icon-text"
                                        >
                                            Edit <i class="mdi mdi-file-check btn-icon-append"></i>
                                        </a>
                                    </a>
                                </td>
                                <td>
                                    <% if (Product[i].status === false) { %>
                                    <a href="/admin/unlist-product?id=<%= Product[i]._id %>">
                                        <button data-product-id="<%= Product[i]._id %>" type="button" class="btn btn-inverse-success btn-fw yy">List</button>
                                    </a>
                                    <% } else { %>
                                    <a href="/admin/unlist-product?id=<%= Product[i]._id %>">
                                        <button data-product-id="<%= Product[i]._id %>" type="button" class="btn btn-inverse-danger btn-fw yy">Unlist</button>
                                    </a>
                                    <% } %>
                                </td>
                            </tr>
                            <% } }else{ %>
                            <tr>
                                <td colspan="5">Product not Found</td>
                            </tr>
                            <% } %>
                        </table>
                        <!-- ------------Adding Pagination -------------- -->

                        <% if (typeof totalPages !== 'undefined') { %>
                        <div class="pagination-container">
                            <% for(let j=1; j <= totalPages; j++){ %>
                            <a href="?page=<%= j %>"><%= j %></a>
                            <% } %>
                        </div>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const productTable = document.getElementById("product-table");
        console.log("fggfg");

        productTable.addEventListener("click", async (event) => {
            if (event.target.classList.contains("yy")) {
                event.preventDefault();

                const productId = event.target.getAttribute("data-product-id");

                try {
                    const response = await fetch(`/admin/unlist-product?id=${productId}`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                    });

                    const data = await response.json();
                    console.log("dfldkf",data);

                    if (response.ok) {
                        const button = event.target;
                        button.textContent = button.textContent === "Unlist" ? "List" : "Unlist";
                        button.classList.toggle("btn-inverse-danger");
                        button.classList.toggle("btn-inverse-success");

                        // Show SweetAlert notification on successful action
                        Swal.fire({
                            title: data.message,
                            icon: "success",
                            showConfirmButton: true,
                            customClass: {
                                popup: "animate__animated animate__fadeInDown",
                                content: "your-custom-class",
                            },
                        });
                    } else {
                        // Handle server error or unexpected response
                        console.error("Error updating product status:", response.statusText);

                        // Show SweetAlert error notification
                        Swal.fire({
                            title: "Error",
                            text: "Failed to update product status.",
                            icon: "error",
                            timer: 3000,
                            showConfirmButton: false,
                            customClass: {
                                popup: "animate__animated animate__fadeInDown",
                                content: "your-custom-class",
                            },
                        });
                    }
                } catch (error) {
                    // Handle network error or JSON parsing error
                    console.error("Error:", error);

                    // Show SweetAlert network error notification
                    Swal.fire({
                        title: "Network Error",
                        text: "Failed to communicate with the server.",
                        icon: "error",
                        timer: 3000,
                        showConfirmButton: false,
                        customClass: {
                            popup: "animate__animated animate__fadeInDown",
                            content: "your-custom-class",
                        },
                    });
                }
            }
        });
    });
</script>


<%- include('../adminLayouts/footer.ejs') %>

    