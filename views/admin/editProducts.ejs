<%- include('../adminLayouts/header.ejs') %> <%- include('../adminLayouts/sidebar.ejs') %> <%-
include('../adminLayouts/navbar.ejs') %>

<div class="main-panel">
    <div class="content-wrapper">
        <div class="col-12 grid-margin stretch-card">
            <div class="card">
                <div class="card-body">
                    <h2 class="card-title">EDIT PRODUCTS</h2>
                    <form
                        class="forms-sample"
                        action=""
                        method="post"
                        enctype="multipart/form-data"
                        onsubmit="return productValidForm()"
                    >
                        <div class="form-row">
                            <div class="col-md-6 form-group">
                                <label for="exampleInputName1">Product Name</label>
                                <input
                                    type="text"
                                    class="form-control"
                                    id="exampleInputName1"
                                    name="productname"
                                    placeholder="ProductName"
                                    value="<%= data.productname %>"
                                />
                            </div>
                            <div class="col-md-6 form-group">
                                <label for="size">Size</label>
                                <input
                                    type="text"
                                    class="form-control"
                                    id="size"
                                    name="size"
                                    placeholder="Size"
                                    value="<%= data.size %>"
                                />
                                <p id="size-error" class="error-message"></p>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="col-md-4 form-group">
                                <label for="category">Category</label>
                                <select class="form-control" id="category" name="category">
                                    <% Category.forEach(category => { %> <option value="<%= category._id %>" <% if
                                    (category._id === data.categoryId) { %> selected <% } %> > <%= category.categoryname %>
                                    <% }); %>
                                </select>
                            </div>
                            <div class="col-md-4 form-group">
                                <label for="price">Price</label>
                                <input
                                    type="text"
                                    class="form-control"
                                    id="price"
                                    name="price"
                                    placeholder="Price"
                                    value="<%= data.price %>"
                                />
                                <p id="price-error" class="error-message"></p>
                            </div>
                            <div class="col-md-4 form-group">
                                <label for="quantity">Quantity</label>
                                <input
                                    type="text"
                                    class="form-control"
                                    id="quantity"
                                    name="quantity"
                                    placeholder="Quantity"
                                    value="<%= data.quantity %>"
                                />
                                <p id="quantity-error" class="error-message"></p>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="description">Description</label>
                            <textarea class="form-control" id="description" rows="4" name="description">
<%= data.description %></textarea
                            >
                            <p id="description-error" class="error-message"></p>
                        </div>

                        <!-- ... other form fields ... -->
                        <div class="container-fluid">
                          <label for="">File upload (Multiple Images)</label>
                          <div class="row dynamic-image-inputs">
                              <!-- Existing images -->
                              <% data.image.forEach((image, index) => { %>
                              <div class="col-md-3 mb-2 existing-image">
                                  <img src="/static/admin/Assets/images/products/<%= image %>"
                                      style="width: 100px; height: 100px" alt="Existing Image" class="product-image" />
                                  <input type="hidden" name="existingImages" value="<%= image %>">
                                  <button class="btn btn-secondary replace-image-button" data-index="<%= index %>">
                                      Replace
                                  </button>
                              </div>
                              <% }); %>
                              <!-- New image inputs will be added here -->
                          </div>
                          <div class="col-md-12 mt-2">
                              <button class="btn btn-primary add-image-input" type="button">Add Image</button>
                          </div>
                          <p id="image-error" class="error-message"></p>
                      </div>

                      <!-- ... rest of the form ... -->

                      <div class="row mt-5">
                          <div class="col-md-12 text-center">
                              <button type="submit" class="btn btn-primary mr-2">Submit</button>
                              <button class="btn btn-dark">Cancel</button>
                          </div>
                      </div>

                      <div class="input-container">
                          <input type="hidden" name="id" value="<%= data._id %>" />
                      </div>
                  </form>
              </div>
          </div>
      </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
      const addImageButton = document.querySelector(".add-image-input");
      const dynamicImageInputs = document.querySelector(".dynamic-image-inputs");

      addImageButton.addEventListener("click", function () {
          // Check if there are no existing image inputs before adding a new one
          const existingInputs = dynamicImageInputs.querySelectorAll('.new-image-input input[type="file"]');
          if (existingInputs.length === 0) {
              // Create new image input field
              const inputGroup = document.createElement("div");
              inputGroup.className = "col-md-3 mb-2 new-image-input";
              const inputFile = document.createElement("input");
              inputFile.type = "file";
              inputFile.name = "images";
              inputFile.className = "form-control";
              inputFile.required = true;
              const removeButton = document.createElement("button");
              removeButton.className = "btn btn-danger remove-image-input";
              removeButton.type = "button";
              removeButton.textContent = "Remove";
              removeButton.addEventListener("click", function () {
                  // Remove the image input field
                  inputGroup.remove();
              });
              inputGroup.appendChild(inputFile);
              inputGroup.appendChild(removeButton);
              dynamicImageInputs.appendChild(inputGroup);
          }
      });

      // Handle existing image replacement
      dynamicImageInputs.addEventListener("click", function (event) {
        if (event.target.classList.contains("replace-image-button") && !event.target.disabled) {
            const index = event.target.getAttribute("data-index");
            const inputFile = document.createElement("input");
            inputFile.type = "file";
            inputFile.name = "images";
            inputFile.className = "form-control";
            inputFile.required = true;
            inputFile.addEventListener("change", function (e) {
                const newImageFile = e.target.files[0];
                if (newImageFile) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const newImageSrc = e.target.result;
                        const newImageElement = document.createElement("img");
                        newImageElement.src = newImageSrc;
                        newImageElement.style.width = "100px";
                        newImageElement.style.height = "100px";
                        // Replace the old image with the new one
                        const existingImageContainer = event.target.parentElement;
                        // Remove the existing image before adding the new one
                        existingImageContainer.querySelector(".product-image").remove();
                        existingImageContainer.insertBefore(newImageElement, event.target);
                        // Disable the replace button after replacement
                        event.target.disabled = true;
                        // Add a class to mark the image as replaced
                        existingImageContainer.classList.add("replaced-image");
                    };
                    reader.readAsDataURL(newImageFile);
                }
            });
            // Insert file input before the "Replace" button
            const existingImageContainer = event.target.parentElement;
            existingImageContainer.insertBefore(inputFile, event.target);
        }
    });
});
</script>

<%- include('../adminLayouts/footer.ejs') %>
